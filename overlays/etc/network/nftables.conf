#!/usr/sbin/nft -f
# LockClaw firewall baseline — deny-by-default
# Load with: systemctl enable --now nftables
# Test with:  nft list ruleset

flush ruleset

table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # Loopback — always allow
        iif "lo" accept

        # Established/related — allow return traffic
        ct state established,related accept

        # Drop invalid packets
        ct state invalid drop

        # ICMP — allow essential types only
        ip protocol icmp icmp type { echo-request, destination-unreachable, time-exceeded } accept
        ip6 nexthdr icmpv6 icmpv6 type { echo-request, destination-unreachable, nd-neighbor-solicit, nd-neighbor-advert, nd-router-solicit, nd-router-advert } accept

        # SSH — allow from any (rate-limited)
        tcp dport 22 ct state new limit rate 4/minute burst 8 packets accept

        # DHCP client — needed for initial network config
        udp sport 67 udp dport 68 accept

        # Log and drop everything else
        limit rate 5/minute burst 10 packets log prefix "nft-drop: " level info
        counter drop
    }

    chain forward {
        type filter hook forward priority 0; policy drop;
        # No forwarding by default
    }

    chain output {
        type filter hook output priority 0; policy accept;
        # Allow all outbound by default
        # Restrict here if you need egress filtering
    }
}
